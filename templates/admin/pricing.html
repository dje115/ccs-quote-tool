{% extends "base.html" %}

{% block title %}Manage Pricing - CCS Quote Tool{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1 class="mb-4">
            <i class="fas fa-pound-sign text-primary"></i> Manage Pricing
        </h1>
    </div>
</div>

<!-- AI-Powered Import Options -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-robot text-primary"></i> AI-Powered Import
                </h5>
            </div>
            <div class="card-body">
                <p class="text-muted mb-3">Import pricing from any spreadsheet format using AI to extract and categorize data automatically.</p>
                <div class="d-grid gap-2">
                    <button class="btn btn-primary" onclick="importFromFolder()">
                        <i class="fas fa-folder-open"></i> Import from Spreadsheet Folder
                    </button>
                    <button class="btn btn-info" onclick="findMissingPricing()">
                        <i class="fas fa-search"></i> Find Missing Pricing
                    </button>
                </div>
                <small class="text-muted mt-2 d-block">
                    Place your spreadsheets in the <code>pricing_spreadsheets</code> folder and click import.
                </small>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-file-excel text-success"></i> Manual Import
                </h5>
            </div>
            <div class="card-body">
                <form id="excelImportForm" enctype="multipart/form-data">
                    <div class="mb-3">
                        <input type="file" class="form-control" id="excelFile" accept=".xlsx,.xls,.csv" required>
                        <div class="form-text">
                            Upload any spreadsheet format. AI will automatically extract pricing data.
                        </div>
                    </div>
                    <button type="submit" class="btn btn-success w-100">
                        <i class="fas fa-upload"></i> Import File
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Add New Pricing Item -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-plus text-primary"></i> Add New Pricing Item
                </h5>
            </div>
            <div class="card-body">
                <form id="addPricingForm">
                    <div class="row">
                        <div class="col-md-3">
                            <label for="category" class="form-label">Category *</label>
                            <select class="form-select" id="category" name="category" required>
                                <option value="">Select Category</option>
                                <option value="cabling">Cabling</option>
                                <option value="wifi">WiFi</option>
                                <option value="cctv">CCTV</option>
                                <option value="door_entry">Door Entry</option>
                                <option value="labor">Labor</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="subcategory" class="form-label">Subcategory</label>
                            <input type="text" class="form-control" id="subcategory" name="subcategory">
                        </div>
                        <div class="col-md-3">
                            <label for="product_name" class="form-label">Product Name *</label>
                            <input type="text" class="form-control" id="product_name" name="product_name" required>
                        </div>
                        <div class="col-md-3">
                            <label for="unit" class="form-label">Unit *</label>
                            <select class="form-select" id="unit" name="unit" required>
                                <option value="">Select Unit</option>
                                <option value="meter">Meter</option>
                                <option value="piece">Piece</option>
                                <option value="hour">Hour</option>
                                <option value="day">Day</option>
                                <option value="point">Point</option>
                                <option value="kg">Kilogram</option>
                                <option value="box">Box</option>
                            </select>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-md-3">
                            <label for="cost_per_unit" class="form-label">Cost Per Unit *</label>
                            <input type="number" class="form-control" id="cost_per_unit" name="cost_per_unit" 
                                   step="0.01" min="0" required>
                        </div>
                        <div class="col-md-3">
                            <label for="supplier" class="form-label">Supplier</label>
                            <input type="text" class="form-control" id="supplier" name="supplier">
                        </div>
                        <div class="col-md-3">
                            <label for="part_number" class="form-label">Part Number</label>
                            <input type="text" class="form-control" id="part_number" name="part_number">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">&nbsp;</label>
                            <div class="d-grid">
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-plus"></i> Add Item
                                </button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Pricing Items Table -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">
                    <i class="fas fa-table"></i> Pricing Items
                </h5>
                <div class="btn-group btn-group-sm">
                    <button class="btn btn-outline-success" onclick="exportPricing()">
                        <i class="fas fa-download"></i> Export
                    </button>
                    <button class="btn btn-outline-warning" onclick="updateWebPricing()">
                        <i class="fas fa-sync-alt"></i> Update from Web
                    </button>
                </div>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>Category</th>
                                <th>Subcategory</th>
                                <th>Product Name</th>
                                <th>Unit</th>
                                <th>Cost</th>
                                <th>Supplier</th>
                                <th>Source</th>
                                <th>Last Updated</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in pricing_items %}
                            <tr>
                                <td>
                                    <span class="badge bg-{{ 'primary' if item.category == 'cabling' else 'info' if item.category == 'wifi' else 'success' if item.category == 'cctv' else 'warning' }}">
                                        {{ item.category.title() }}
                                    </span>
                                </td>
                                <td>{{ item.subcategory or '-' }}</td>
                                <td>{{ item.product_name }}</td>
                                <td>{{ item.unit }}</td>
                                <td>Â£{{ "%.2f"|format(item.cost_per_unit) }}</td>
                                <td>{{ item.supplier or '-' }}</td>
                                <td>
                                    <span class="badge bg-{{ 'success' if item.source == 'web' else 'secondary' }}">
                                        {{ item.source.title() }}
                                    </span>
                                </td>
                                <td>{{ item.last_updated.strftime('%d/%m/%Y') }}</td>
                                <td>
                                    <div class="btn-group btn-group-sm">
                                        <button class="btn btn-outline-primary" onclick="editPricingItem({{ item.id }})" title="Edit">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button class="btn btn-outline-danger" onclick="deletePricingItem({{ item.id }})" title="Delete">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Excel import form
    document.getElementById('excelImportForm').addEventListener('submit', function(e) {
        e.preventDefault();
        importExcel();
    });
    
    // Add pricing form
    document.getElementById('addPricingForm').addEventListener('submit', function(e) {
        e.preventDefault();
        addPricingItem();
    });
});

function importExcel() {
    const formData = new FormData();
    const fileInput = document.getElementById('excelFile');
    
    if (fileInput.files.length === 0) {
        alert('Please select a file to upload.');
        return;
    }
    
    formData.append('file', fileInput.files[0]);
    
    const button = event.target.querySelector('button[type="submit"]');
    const originalText = button.innerHTML;
    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Importing...';
    button.disabled = true;
    
    fetch('{{ url_for("admin.import_excel_pricing") }}', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            alert(result.message);
            location.reload();
        } else {
            alert('Error: ' + result.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred while importing the file.');
    })
    .finally(() => {
        button.innerHTML = originalText;
        button.disabled = false;
    });
}

function addPricingItem() {
    const formData = new FormData(document.getElementById('addPricingForm'));
    const data = {};
    
    for (let [key, value] of formData.entries()) {
        data[key] = value;
    }
    
    fetch('{{ url_for("admin.add_pricing_item") }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            alert(result.message);
            document.getElementById('addPricingForm').reset();
            location.reload();
        } else {
            alert('Error: ' + result.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred while adding the pricing item.');
    });
}

function editPricingItem(itemId) {
    // This would implement editing functionality
    alert('Edit functionality coming soon!');
}

function deletePricingItem(itemId) {
    if (confirm('Are you sure you want to delete this pricing item?')) {
        fetch(`/admin/pricing/${itemId}/delete`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                location.reload();
            } else {
                alert('Error: ' + result.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while deleting the item.');
        });
    }
}

function exportPricing() {
    // This would implement export functionality
    alert('Export functionality coming soon!');
}

function updateWebPricing() {
    if (confirm('Update pricing from web sources? This may take a few minutes.')) {
        const button = event.target;
        const originalText = button.innerHTML;
        
        button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Updating...';
        button.disabled = true;
        
        fetch('/api/update-pricing', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                alert(result.message);
                location.reload();
            } else {
                alert('Error: ' + result.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while updating pricing.');
        })
        .finally(() => {
            button.innerHTML = originalText;
            button.disabled = false;
        });
    }
}

function importFromFolder() {
    if (confirm('Import pricing from all spreadsheets in the pricing_spreadsheets folder? This will process all files using AI.')) {
        const button = event.target;
        const originalText = button.innerHTML;
        
        button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Importing...';
        button.disabled = true;
        
        fetch('/api/import-spreadsheet-folder', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                alert(result.message);
                location.reload();
            } else {
                alert('Error: ' + result.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while importing from folder.');
        })
        .finally(() => {
            button.innerHTML = originalText;
            button.disabled = false;
        });
    }
}

function findMissingPricing() {
    // Get sample quote requirements for testing
    const sampleRequirements = {
        wifi_requirements: 'UniFi U6 Pro access points, PoE switches',
        cctv_requirements: 'UniFi G4 Pro cameras, NVR system',
        door_entry_requirements: 'Net2 Entry Pro system with card readers',
        special_requirements: 'Cat6a cabling for future-proofing'
    };
    
    const button = event.target;
    const originalText = button.innerHTML;
    
    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Analyzing...';
    button.disabled = true;
    
    fetch('/api/find-missing-pricing', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            quote_requirements: sampleRequirements
        })
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            if (result.missing_products && result.missing_products.length > 0) {
                let message = 'Missing pricing found for:\n\n';
                result.missing_products.forEach(product => {
                    message += `â¢ ${product.product_name}\n`;
                    if (product.suggested_suppliers) {
                        message += `  Suppliers: ${product.suggested_suppliers}\n`;
                    }
                    if (product.estimated_price_range) {
                        message += `  Price Range: ${product.estimated_price_range}\n`;
                    }
                    message += '\n';
                });
                alert(message);
            } else {
                alert('No missing pricing found! All products in the sample requirements have pricing data.');
            }
        } else {
            alert('Error: ' + result.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred while analyzing missing pricing.');
    })
    .finally(() => {
        button.innerHTML = originalText;
        button.disabled = false;
    });
}
</script>
{% endblock %}
