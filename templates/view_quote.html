{% extends "base.html" %}

{% block title %}{{ quote.quote_number }} - CCS Quote Tool{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1>
                <i class="fas fa-file-invoice text-primary"></i> 
                Quote {{ quote.quote_number }}
            </h1>
            <div class="btn-group">
                <a href="{{ url_for('main.generate_document', quote_id=quote.id) }}" 
                   class="btn btn-success">
                    <i class="fas fa-file-word"></i> Generate Word Doc
                </a>
                <a href="{{ url_for('main.send_quote', quote_id=quote.id) }}" 
                   class="btn btn-primary">
                    <i class="fas fa-envelope"></i> Send Quote
                </a>
                <a href="{{ url_for('main.quotes_list') }}" 
                   class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left"></i> Back to Quotes
                </a>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- Main Quote Details -->
    <div class="col-lg-8">
        <!-- Client Information -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-user"></i> Client Information
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <p><strong>Client:</strong> {{ quote.client_name }}</p>
                        <p><strong>Email:</strong> {{ quote.client_email or 'Not provided' }}</p>
                        {% if quote.customer %}
                        <p><strong>Customer:</strong> 
                            <a href="{{ url_for('crm.view_customer', customer_id=quote.customer.id) }}" class="text-decoration-none">
                                {{ quote.customer.name }} <i class="fas fa-external-link-alt small"></i>
                            </a>
                        </p>
                        {% endif %}
                    </div>
                    <div class="col-md-6">
                        <p><strong>Phone:</strong> {{ quote.client_phone or 'Not provided' }}</p>
                        {% if quote.customer and quote.customer.business_sector %}
                        <p><strong>Sector:</strong> <span class="badge bg-info">{{ quote.customer.business_sector.value }}</span></p>
                        {% endif %}
                        <p><strong>Created:</strong> {{ quote.created_at.strftime('%d/%m/%Y %H:%M') }}</p>
                    </div>
                </div>
                <p><strong>Site Address:</strong> {{ quote.site_address }}</p>
            </div>
        </div>
        
        <!-- Project Details -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-project-diagram"></i> Project Details
                </h5>
            </div>
            <div class="card-body">
                <h6>{{ quote.project_title }}</h6>
                {% if quote.project_description %}
                <p>{{ quote.project_description }}</p>
                {% endif %}
                
                <div class="row">
                    <div class="col-md-6">
                        {% if quote.building_type %}
                        <p><strong>Building Type:</strong> {{ quote.building_type.title() }}</p>
                        {% endif %}
                        {% if quote.building_size %}
                        <p><strong>Building Size:</strong> {{ quote.building_size }} sqm</p>
                        {% endif %}
                    </div>
                    <div class="col-md-6">
                        {% if quote.number_of_floors %}
                        <p><strong>Floors:</strong> {{ quote.number_of_floors }}</p>
                        {% endif %}
                        {% if quote.number_of_rooms %}
                        <p><strong>Rooms/Areas:</strong> {{ quote.number_of_rooms }}</p>
                        {% endif %}
                    </div>
                </div>
                
                <!-- Requirements -->
                <div class="mt-3">
                    <strong>Requirements:</strong>
                    <div class="mt-2">
                        {% if quote.wifi_requirements %}
                        <span class="badge bg-primary me-2">
                            <i class="fas fa-wifi"></i> WiFi (UniFi)
                        </span>
                        {% endif %}
                        {% if quote.cctv_requirements %}
                        <span class="badge bg-info me-2">
                            <i class="fas fa-video"></i> CCTV (UniFi)
                        </span>
                        {% endif %}
                        {% if quote.door_entry_requirements %}
                        <span class="badge bg-warning me-2">
                            <i class="fas fa-door-open"></i> Door Entry (Paxton/UniFi)
                        </span>
                        {% endif %}
                        {% if quote.cabling_type %}
                        <span class="badge bg-secondary me-2">
                            <i class="fas fa-cable-car"></i> {{ quote.cabling_type.upper() }} Cabling
                        </span>
                        {% endif %}
                    </div>
                </div>
                
                {% if quote.special_requirements %}
                <div class="mt-3">
                    <strong>Special Requirements:</strong>
                    <p>{{ quote.special_requirements }}</p>
                </div>
                {% endif %}
            </div>
        </div>
        
        <!-- AI Analysis & Quotation -->
        {% if quote.ai_analysis %}
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">
                    <i class="fas fa-robot text-info"></i> AI Analysis &amp; Quotation
                </h5>
                {% if quote.travel_distance_km %}
                <span class="badge bg-info">Travel: {{ '%.1f'|format(quote.travel_distance_km * 0.621371) }} miles</span>
                {% endif %}
                {% if quote.travel_cost %}
                <span class="badge bg-warning">Travel Cost: £{{ '%.2f'|format(quote.travel_cost) }}</span>
                {% endif %}
            </div>
            <div class="card-body">
                <!-- Original Project Description -->
                {% if quote.project_description %}
                <div class="alert alert-light border mb-3">
                    <h6><i class="fas fa-file-text"></i> Original Project Specification</h6>
                    <p class="mb-0 fst-italic">{{ quote.project_description }}</p>
                </div>
                {% endif %}
                
                <p>{{ quote.ai_analysis }}</p>
                {% set labour_breakdown = quote.labour_breakdown and quote.labour_breakdown|from_json or [] %}
                {% set quotation_details = quote.quotation_details and quote.quotation_details|from_json or {} %}
                {% set assumptions = quotation_details.assumptions_exclusions or [] %}
                {% set scope = quotation_details.scope_of_works or [] %}
                {% set materials = quotation_details.materials or [] %}
                {% set labour = quotation_details.labour or {} %}
                {% set alternatives = quote.alternative_solutions and quote.alternative_solutions|from_json or [] %}

                {% if scope %}
                <h6 class="mt-3"><i class="fas fa-sitemap"></i> Scope of Works</h6>
                <ul>{% for item in scope %}<li>{{ item }}</li>{% endfor %}</ul>
                {% endif %}

                {% if materials %}
                <h6><i class="fas fa-box-open"></i> Materials</h6>
                <ul>{% for item in materials %}<li><strong>{{ item.item or item.name }}</strong> {% if item.quantity %} (Qty: {{ item.quantity }}){% endif %}{% if item.notes %} - {{ item.notes }}{% endif %}</li>{% endfor %}</ul>
                {% endif %}

                {% if labour_breakdown %}
                <h6><i class="fas fa-tools"></i> Labour Breakdown</h6>
                <ul>
                    {% for item in labour_breakdown %}
                    <li><strong>{{ item.task or item.name }}</strong>: {{ item.hours }} hrs{% if item.days %} ({{ item.days }} days){% endif %}{% if item.notes %} - {{ item.notes }}{% endif %}</li>
                    {% endfor %}
                </ul>
                {% endif %}

                {% if labour.hours %}
                <p class="text-muted small">Summary: {{ labour.hours }} hrs ({{ (labour.hours/8)|round(2) }} days) • Engineers: {{ labour.engineers or 'n/a' }} • Total Labour £{{ labour.total_cost or '0' }}</p>
                {% endif %}

                {% if assumptions %}
                <h6><i class="fas fa-info-circle"></i> Assumptions &amp; Exclusions</h6>
                <ul>{% for item in assumptions %}<li>{{ item }}</li>{% endfor %}</ul>
                {% endif %}

                {% if alternatives %}
                <h6><i class="fas fa-lightbulb"></i> Alternatives</h6>
                <ul>
                    {% for alt in alternatives %}
                    <li><strong>{{ alt.solution or alt.option or alt.name }}</strong> {% if alt.pros %}Pros: {{ alt.pros }}{% endif %}{% if alt.cons %} • Cons: {{ alt.cons }}{% endif %}</li>
                    {% endfor %}
                </ul>
                {% endif %}

                {% if quote.travel_distance_km %}
                <div class="alert alert-info mt-3">
                    <i class="fas fa-route"></i> Estimated travel: {{ '%.1f'|format(quote.travel_distance_km) }} km (~{{ quote.travel_time_minutes|round }} minutes)
                </div>
                {% endif %}

                <!-- Raw AI Response (for debugging/reference) -->
                {% if quote.ai_raw_response %}
                <div class="mt-4">
                    <details>
                        <summary class="btn btn-outline-secondary btn-sm">
                            <i class="fas fa-code"></i> View Raw AI Response
                        </summary>
                        <div class="mt-2 p-3 bg-light border rounded" style="font-family: 'Courier New', monospace; font-size: 0.85em; max-height: 400px; overflow-y: auto;">
                            <pre>{{ quote.ai_raw_response }}</pre>
                        </div>
                    </details>
                </div>
                {% endif %}
            </div>
        </div>
        {% endif %}
        
        <!-- Pricing Breakdown -->
        {% if quote_data %}
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-pound-sign text-success"></i> Pricing Breakdown
                </h5>
            </div>
            <div class="card-body">
                <!-- Materials -->
                {% if quote_data.materials %}
                <h6>Materials</h6>
                <div class="table-responsive mb-3">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Item</th>
                                <th>Part Number</th>
                                <th>Quantity</th>
                                <th>Unit Price</th>
                                <th>Total</th>
                                <th>Source</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for material in quote_data.materials %}
                            <tr>
                                <td>
                                    {{ material.item }}
                                    {% if material.is_estimated %}
                                        <span class="text-warning" title="Estimated pricing">*</span>
                                    {% endif %}
                                </td>
                                <td><small class="text-muted">{{ material.part_number or '-' }}</small></td>
                                <td>{{ material.quantity }} {{ material.unit }}</td>
                                <td>
                                    £{{ "%.2f"|format(material.unit_price) }}
                                    {% if material.is_estimated %}
                                        <span class="text-warning" title="Estimated pricing">*</span>
                                    {% endif %}
                                </td>
                                <td>
                                    £{{ "%.2f"|format(material.total) }}
                                    {% if material.is_estimated %}
                                        <span class="text-warning" title="Estimated pricing">*</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if material.pricing_source %}
                                        <span class="badge bg-{{ 'warning' if material.pricing_source == 'ai_estimated' else 'info' if material.pricing_source == 'web_scraper' else 'secondary' if material.pricing_source == 'database' else 'danger' }}">
                                            {{ material.pricing_source.replace('_', ' ').title() }}
                                        </span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                <div class="text-end">
                    <strong>Total Materials: £{{ "%.2f"|format(quote_data.total_materials) }}</strong>
                </div>
                
                <!-- Pricing Legend -->
                {% set has_estimated = quote_data.materials | selectattr('is_estimated', 'equalto', true) | list | length > 0 %}
                {% if has_estimated %}
                <div class="alert alert-info mt-3">
                    <small>
                        <i class="fas fa-info-circle"></i> 
                        <strong>Pricing Legend:</strong> 
                        <span class="text-warning">*</span> = Estimated pricing based on average market data. 
                        Actual supplier quotes may vary. Please confirm final pricing before proceeding.
                    </small>
                </div>
                {% endif %}
                {% endif %}
                
                <!-- Labor -->
                {% if quote_data.labor %}
                <hr>
                <h6>Labor</h6>
                <div class="table-responsive mb-3">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Service</th>
                                <th>Hours</th>
                                <th>Rate</th>
                                <th>Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for labor in quote_data.labor %}
                            <tr>
                                <td>{{ labor.item }}</td>
                                <td>{{ labor.quantity }} {{ labor.unit }}</td>
                                <td>£{{ "%.2f"|format(labor.unit_price) }}</td>
                                <td>£{{ "%.2f"|format(labor.total) }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                <div class="text-end">
                    <strong>Total Labor: £{{ "%.2f"|format(quote_data.total_labor) }}</strong>
                </div>
                {% endif %}
                
                <!-- Total -->
                <hr>
                <div class="text-end">
                    <h4 class="text-success">
                        TOTAL COST: £{{ "%.2f"|format(quote_data.total_cost) }}
                    </h4>
                </div>
            </div>
        </div>
        {% endif %}
        
        <!-- Recommended Products -->
        {% if recommended_products %}
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-box text-primary"></i> Recommended Products
                </h5>
            </div>
            <div class="card-body">
                <ul class="list-group list-group-flush">
                    {% for product in recommended_products %}
                    <li class="list-group-item">
                        <i class="fas fa-check text-success"></i> {{ product }}
                    </li>
                    {% endfor %}
                </ul>
            </div>
        </div>
        {% endif %}
        
        <!-- Alternative Solutions -->
        {% if alternative_solutions %}
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-lightbulb text-warning"></i> Alternative Solutions
                </h5>
            </div>
            <div class="card-body">
                {% for solution in alternative_solutions %}
                <div class="alternative-solution">
                    <h6>Option {{ loop.index }}</h6>
                    <p>{{ solution }}</p>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}
    </div>
    
    <!-- Sidebar -->
    <div class="col-lg-4">
        <!-- Quote Status -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-info-circle"></i> Quote Status
                </h5>
            </div>
            <div class="card-body text-center">
                {% if quote.status == 'draft' %}
                    <span class="badge bg-secondary fs-6">Draft</span>
                {% elif quote.status == 'sent' %}
                    <span class="badge bg-primary fs-6">Sent</span>
                {% elif quote.status == 'accepted' %}
                    <span class="badge bg-success fs-6">Accepted</span>
                {% elif quote.status == 'declined' %}
                    <span class="badge bg-danger fs-6">Declined</span>
                {% endif %}
                
                {% if quote.estimated_time %}
                <div class="mt-3">
                    <small class="text-muted">Estimated Time</small><br>
                    <strong>{{ quote.estimated_time }} hours</strong>
                </div>
                {% endif %}
            </div>
        </div>
        
        <!-- Quick Actions -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-tools"></i> Quick Actions
                </h5>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <a href="{{ url_for('main.generate_document', quote_id=quote.id) }}" 
                       class="btn btn-success">
                        <i class="fas fa-file-word"></i> Generate Word Document
                    </a>
                    <a href="{{ url_for('main.send_quote', quote_id=quote.id) }}" 
                       class="btn btn-primary">
                        <i class="fas fa-envelope"></i> Send Quote via Email
                    </a>
                    <button class="btn btn-outline-info" onclick="duplicateQuote()">
                        <i class="fas fa-copy"></i> Duplicate Quote
                    </button>
                    {% if current_user.is_admin %}
                    <button class="btn btn-outline-danger" onclick="deleteQuote()">
                        <i class="fas fa-trash"></i> Delete Quote
                    </button>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <!-- Quote Information -->
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-info"></i> Quote Information
                </h5>
            </div>
            <div class="card-body">
                <div class="small">
                    <div class="d-flex justify-content-between mb-2">
                        <span>Quote Number:</span>
                        <span class="fw-bold">{{ quote.quote_number }}</span>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <span>Created:</span>
                        <span>{{ quote.created_at.strftime('%d/%m/%Y') }}</span>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <span>Last Updated:</span>
                        <span>{{ quote.updated_at.strftime('%d/%m/%Y') }}</span>
                    </div>
                    <div class="d-flex justify-content-between">
                        <span>Created By:</span>
                        <span>{{ quote.creator.username }}</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function duplicateQuote() {
    if (confirm('Create a duplicate of this quote?')) {
        // This would implement quote duplication
        alert('Quote duplication feature coming soon!');
    }
}

function deleteQuote() {
    if (confirm('Are you sure you want to delete this quote? This action cannot be undone.')) {
        fetch(`/admin/quotes/{{ quote.id }}/delete`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                window.location.href = '{{ url_for("main.quotes_list") }}';
            } else {
                alert('Error: ' + result.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while deleting the quote.');
        });
    }
}
</script>
{% endblock %}
