{% extends "base.html" %}

{% block title %}{{ customer.company_name }}{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-md-8">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2>{{ customer.company_name }}</h2>
                <div>
                    <a href="{{ url_for('crm.edit_customer', customer_id=customer.id) }}" class="btn btn-secondary">
                        <i class="fas fa-edit"></i> Edit
                    </a>
                    <button class="btn btn-info" onclick="analyzeCustomer()">
                        <i class="fas fa-robot"></i> AI Analysis
                    </button>
                </div>
            </div>
            
            <!-- Basic Information -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5>Basic Information</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                        <p><strong>Website:</strong> 
                            {% if customer.website %}
                            <a href="{{ customer.website }}" target="_blank">{{ customer.website }} <i class="fas fa-external-link-alt"></i></a>
                            {% else %}
                            <span class="text-muted">Not provided</span>
                            {% endif %}
                        </p>
                        <p><strong>Company Registration:</strong> 
                            {% if customer.company_registration %}
                            <span class="badge {% if customer.registration_confirmed %}bg-success{% else %}bg-warning{% endif %}">{{ customer.company_registration }}</span>
                            <div class="form-check mt-2">
                                <input class="form-check-input" type="checkbox" id="registration_confirmed" 
                                       {% if customer.registration_confirmed %}checked{% endif %}
                                       onchange="toggleRegistrationConfirmation(this)">
                                <label class="form-check-label" for="registration_confirmed">
                                    <small class="text-muted">Confirmed by human</small>
                                </label>
                            </div>
                            {% else %}
                            <span class="text-muted">Not provided</span>
                            {% endif %}
                        </p>
                        <p><strong>Phone:</strong> {{ customer.main_phone or 'Not provided' }}</p>
                        <p><strong>Email:</strong> {{ customer.main_email or 'Not provided' }}</p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>Status:</strong> 
                                <span class="badge {% if customer.status.value == 'active' %}bg-success{% elif customer.status.value == 'lead' %}bg-primary{% elif customer.status.value == 'prospect' %}bg-info{% elif customer.status.value == 'inactive' %}bg-warning{% else %}bg-secondary{% endif %}" id="status-badge">
                                    {{ customer.status.value.title() }}
                                </span>
                                <button class="btn btn-sm btn-outline-secondary ms-2" onclick="showStatusChangeModal()">
                                    <i class="fas fa-edit"></i> Change
                                </button>
                            </p>
                            <p><strong>Created:</strong> {{ customer.created_at.strftime('%Y-%m-%d') }}</p>
                            <p><strong>Updated:</strong> {{ customer.updated_at.strftime('%Y-%m-%d') }}</p>
                        </div>
                    </div>
                    
                    <!-- Address Information -->
                    <div class="mt-3">
                        <h6><i class="fas fa-map-marker-alt text-primary"></i> Address Information</h6>
                        
                        {% if customer.billing_address %}
                        <div class="mb-2">
                            <strong>Billing Address:</strong><br>
                            <span class="text-muted">{{ customer.billing_address }}</span>
                            {% if customer.billing_postcode %}
                            <br><span class="text-muted">{{ customer.billing_postcode }}</span>
                            {% endif %}
                            <br>
                            <a href="https://www.google.com/maps/search/?api=1&query={{ customer.billing_address|urlencode }}{% if customer.billing_postcode %} {{ customer.billing_postcode|urlencode }}{% endif %}" 
                               target="_blank" 
                               class="btn btn-outline-primary btn-sm mt-1">
                                <i class="fas fa-map-marker-alt"></i> Open in Google Maps
                            </a>
                        </div>
                        {% endif %}
                        
                        {% if customer.shipping_address %}
                        <div class="mb-2">
                            <strong>Shipping Address:</strong><br>
                            <span class="text-muted">{{ customer.shipping_address }}</span>
                            {% if customer.shipping_postcode %}
                            <br><span class="text-muted">{{ customer.shipping_postcode }}</span>
                            {% endif %}
                            <br>
                            <a href="https://www.google.com/maps/search/?api=1&query={{ customer.shipping_address|urlencode }}{% if customer.shipping_postcode %} {{ customer.shipping_postcode|urlencode }}{% endif %}" 
                               target="_blank" 
                               class="btn btn-outline-primary btn-sm mt-1">
                                <i class="fas fa-map-marker-alt"></i> Open in Google Maps
                            </a>
                        </div>
                        {% endif %}
                        
                        {% if not customer.billing_address and not customer.shipping_address %}
                        <p class="text-muted">No address information available</p>
                        {% endif %}
                        
                        <!-- AI-Generated Address Analysis -->
                        {% if customer.primary_address or customer.additional_sites or customer.location_analysis %}
                        <div class="mt-3 pt-3 border-top">
                            <h6><i class="fas fa-robot text-info"></i> AI Address Analysis</h6>
                            
                            {% if customer.primary_address %}
                            <div class="mb-2">
                                <strong>Primary Business Address:</strong><br>
                                <span class="text-muted">{{ customer.primary_address }}</span>
                                <br>
                                <a href="https://www.google.com/maps/search/?api=1&query={{ customer.primary_address|urlencode }}" 
                                   target="_blank" 
                                   class="btn btn-outline-primary btn-sm mt-1">
                                    <i class="fas fa-map-marker-alt"></i> Open in Google Maps
                                </a>
                            </div>
                            {% endif %}
                            
                            {% if customer.additional_sites %}
                            <div class="mb-2">
                                <strong>Additional Sites:</strong><br>
                                <span class="text-muted">{{ customer.additional_sites }}</span>
                            </div>
                            {% endif %}
                            
                            {% if customer.location_analysis %}
                            <div class="mb-2">
                                <strong>Location Analysis:</strong><br>
                                <span class="text-muted">{{ customer.location_analysis }}</span>
                            </div>
                            {% endif %}
                            
                            {% if customer.google_maps_data %}
                            <div class="mb-2">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <strong>Google Maps Locations:</strong>
                                    <button type="button" class="btn btn-sm btn-outline-success" onclick="showAddAddressModal()">
                                        <i class="fas fa-plus"></i> Add Address
                                    </button>
                                </div>
                                {% set maps_data = customer.google_maps_data|from_json %}
                                {% set excluded_addresses = customer.excluded_addresses|from_json if customer.excluded_addresses else [] %}
                                {% set manual_addresses = customer.manual_addresses|from_json if customer.manual_addresses else [] %}
                                
                                <!-- Manual Addresses -->
                                {% if manual_addresses and manual_addresses|length > 0 %}
                                    {% for address in manual_addresses %}
                                        <div class="small mb-2 p-2 border rounded bg-light" id="manual_address_{{ loop.index }}">
                                            <div class="d-flex justify-content-between align-items-start">
                                                <div class="flex-grow-1">
                                                    <div class="d-flex align-items-center mb-1">
                                                        <input type="checkbox" class="form-check-input me-2 address-checkbox" 
                                                               id="manual_checkbox_{{ loop.index }}"
                                                               data-address-name="{{ address.name }}"
                                                               data-address-address="{{ address.address }}"
                                                               data-address-phone="{{ address.phone or '' }}"
                                                               data-address-type="manual">
                                                        <strong><i class="fas fa-user-plus text-success"></i> {{ address.name }}</strong>
                                                    </div>
                                                    <span class="text-muted">{{ address.address }}</span>
                                                    {% if address.phone %}
                                                        <br><i class="fas fa-phone"></i> {{ address.phone }}
                                                    {% endif %}
                                                    {% if address.notes %}
                                                        <br><small class="text-info">{{ address.notes }}</small>
                                                    {% endif %}
                                                    <br>
                                                    <a href="https://www.google.com/maps/search/?api=1&query={{ address.address|urlencode }}" 
                                                       target="_blank" 
                                                       class="btn btn-outline-primary btn-sm mt-1">
                                                        <i class="fas fa-map-marker-alt"></i> Open in Google Maps
                                                    </a>
                                                </div>
                                                <div class="text-end">
                                                    <button type="button" class="btn btn-sm btn-outline-danger" 
                                                            onclick="removeManualAddress('{{ address.name }}', {{ customer.id }})">
                                                        <i class="fas fa-times"></i>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    {% endfor %}
                                {% endif %}
                                
                                <!-- Google Maps Addresses -->
                                {% if maps_data.locations and maps_data.locations|length > 0 %}
                                    {% for location in maps_data.locations %}
                                        {% set location_id = location.name|replace(' ', '_')|replace('.', '_')|replace(',', '_') %}
                                        {% if location_id not in excluded_addresses %}
                                            <div class="small mb-2 p-2 border rounded" id="address_{{ location_id }}">
                                                <div class="d-flex justify-content-between align-items-start">
                                                    <div class="flex-grow-1">
                                                        <div class="d-flex align-items-center mb-1">
                                                            <input type="checkbox" class="form-check-input me-2 address-checkbox" 
                                                                   id="maps_checkbox_{{ loop.index }}"
                                                                   data-address-name="{{ location.name }}"
                                                                   data-address-address="{{ location.address }}"
                                                                   data-address-phone="{{ location.phone or '' }}"
                                                                   data-address-type="google_maps">
                                                            <strong>{{ location.name }}</strong>
                                                        </div>
                                                        <span class="text-muted">{{ location.address }}</span>
                                                        {% if location.phone %}
                                                            <br><i class="fas fa-phone"></i> {{ location.phone }}
                                                        {% endif %}
                                                        {% if location.rating %}
                                                            <br><i class="fas fa-star text-warning"></i> {{ location.rating }}/5
                                                        {% endif %}
                                                        <br>
                                                        <a href="https://www.google.com/maps/search/?api=1&query={{ location.address|urlencode }}" 
                                                           target="_blank" 
                                                           class="btn btn-outline-primary btn-sm mt-1">
                                                            <i class="fas fa-map-marker-alt"></i> Open in Google Maps
                                                        </a>
                                                    </div>
                                                    <div class="text-end">
                                                        <div class="form-check">
                                                            <input class="form-check-input" type="checkbox" 
                                                                   id="exclude_{{ location_id }}"
                                                                   onchange="toggleAddressExclusion('{{ location_id }}', {{ customer.id }}, this.checked)">
                                                            <label class="form-check-label small text-muted" for="exclude_{{ location_id }}">
                                                                Not this business
                                                            </label>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        {% endif %}
                                    {% endfor %}
                                {% else %}
                                    {% if not manual_addresses or manual_addresses|length == 0 %}
                                        <span class="text-muted">No Google Maps locations found</span>
                                    {% endif %}
                                {% endif %}
                                
                                <!-- Excluded Addresses (collapsed) -->
                                {% if excluded_addresses and excluded_addresses|length > 0 %}
                                    <div class="mt-2">
                                        <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#excludedAddresses" aria-expanded="false">
                                            <i class="fas fa-eye-slash"></i> Show Excluded Addresses ({{ excluded_addresses|length }})
                                        </button>
                                        <div class="collapse mt-2" id="excludedAddresses">
                                            {% for location in maps_data.locations %}
                                                {% set location_id = location.name|replace(' ', '_')|replace('.', '_')|replace(',', '_') %}
                                                {% if location_id in excluded_addresses %}
                                                    <div class="small mb-2 p-2 border rounded bg-light text-muted">
                                                        <div class="d-flex justify-content-between align-items-start">
                                                            <div>
                                                                <strong><i class="fas fa-ban text-danger"></i> {{ location.name }}</strong><br>
                                                                <span class="text-muted">{{ location.address }}</span>
                                                                <br><small class="text-muted">Excluded from display</small>
                                                            </div>
                                                            <div class="text-end">
                                                                <button type="button" class="btn btn-sm btn-outline-success" 
                                                                        onclick="toggleAddressExclusion('{{ location_id }}', {{ customer.id }}, false)">
                                                                    <i class="fas fa-undo"></i> Restore
                                                                </button>
                                                            </div>
                                                        </div>
                                                    </div>
                                                {% endif %}
                                            {% endfor %}
                                        </div>
                                    </div>
                                {% endif %}
                            </div>
                            {% endif %}
                            
                            <!-- Add Selected Addresses to Campaign -->
                            {% if (customer.google_maps_data and (customer.google_maps_data|from_json).locations|length > 0) or (customer.manual_addresses and (customer.manual_addresses|from_json)|length > 0) %}
                            <div class="mt-3">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <h6><i class="fas fa-map-marker-alt text-success"></i> Address Selection</h6>
                                    <button class="btn btn-sm btn-outline-primary" onclick="addSelectedAddressesToCampaign()" title="Add selected addresses to lead generation campaign" id="addToCampaignBtn" disabled>
                                        <i class="fas fa-plus"></i> Add Selected (<span id="selectedCount">0</span>)
                                    </button>
                                </div>
                                <p class="text-muted small">
                                    Select interesting addresses to create targeted lead generation campaigns. Perfect for finding potential customers at different locations.
                                </p>
                            </div>
                            {% endif %}
                        </div>
                        {% endif %}
                    </div>
                    
                    {% if customer.description %}
                    <p><strong>Description:</strong><br>{{ customer.description }}</p>
                    {% endif %}
                </div>
            </div>
            
            <!-- AI Business Intelligence -->
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5>Business Intelligence</h5>
                    {% if not customer.ai_analysis_raw %}
                    <small class="text-muted">Click AI Analysis to populate this data</small>
                    {% endif %}
                </div>
                <div class="card-body">
                    {% if customer.ai_analysis_raw %}
                    <div class="row">
                        <div class="col-md-6">
                            <p><strong>Business Sector:</strong> 
                                {% if customer.business_sector %}
                                <span class="badge bg-info">{{ customer.business_sector.value }}</span>
                                {% else %}
                                <span class="text-muted">Not analyzed</span>
                                {% endif %}
                            </p>
                            <p><strong>Company Size:</strong> {{ customer.business_size_category or 'Not analyzed' }}</p>
                            <p><strong>Technology Maturity:</strong> {{ customer.technology_maturity or 'Not analyzed' }}</p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>IT Budget Estimate:</strong> 
                                {% if customer.it_budget_estimate %}
                                {{ customer.it_budget_estimate }}
                                {% else %}
                                <span class="text-muted">Not analyzed</span>
                                {% endif %}
                            </p>
                            <p><strong>Growth Potential:</strong> 
                                {% if customer.growth_potential %}
                                <span class="badge {% if customer.growth_potential == 'High' %}bg-success{% elif customer.growth_potential == 'Medium' %}bg-warning{% else %}bg-secondary{% endif %}">
                                    {{ customer.growth_potential }}
                                </span>
                                {% else %}
                                <span class="text-muted">Not analyzed</span>
                                {% endif %}
                            </p>
                            <p><strong>Lead Score:</strong> 
                                {% if customer.lead_score > 0 %}
                                <span class="badge {% if customer.lead_score >= 70 %}bg-success{% elif customer.lead_score >= 40 %}bg-warning{% else %}bg-secondary{% endif %}">
                                    {{ customer.lead_score }}/100
                                </span>
                                {% else %}
                                <span class="text-muted">Not analyzed</span>
                                {% endif %}
                            </p>
                        </div>
                    </div>
                    
                    <!-- Additional AI Insights -->
                    {% if customer.ai_company_profile %}
                    <div class="mt-4">
                        <h6><i class="fas fa-brain text-info"></i> AI Company Profile</h6>
                        <p class="text-muted">{{ customer.ai_company_profile }}</p>
                    </div>
                    {% endif %}
                    
                    {% if customer.ai_technology_needs %}
                    <div class="mt-3">
                        <h6><i class="fas fa-cogs text-primary"></i> Technology Needs</h6>
                        <p class="text-muted">{{ customer.ai_technology_needs }}</p>
                    </div>
                    {% endif %}
                    
                    {% if customer.ai_opportunities %}
                    <div class="mt-3">
                        <h6><i class="fas fa-lightbulb text-success"></i> Opportunities</h6>
                        <p class="text-muted">{{ customer.ai_opportunities }}</p>
                    </div>
                    {% endif %}
                    
                    {% if customer.ai_competitors %}
                    <div class="mt-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h6><i class="fas fa-users text-warning"></i> Competitors</h6>
                            <button class="btn btn-sm btn-outline-primary" onclick="addCompetitorsToCampaign()" title="Add competitors to lead generation campaign">
                                <i class="fas fa-plus"></i> Add to Campaign
                            </button>
                        </div>
                        <p class="text-muted" id="competitors-text">{{ customer.ai_competitors }}</p>
                    </div>
                    {% endif %}
                    
                    {% if customer.ai_risks %}
                    <div class="mt-3">
                        <h6><i class="fas fa-exclamation-triangle text-danger"></i> Risk Factors</h6>
                        <p class="text-muted">{{ customer.ai_risks }}</p>
                    </div>
                    {% endif %}
                    
                    <!-- Active Directors -->
                    {% if customer.companies_house_data %}
                    {% set ch_data = customer.companies_house_data|from_json %}
                    {% if ch_data.get('accounts_detail') and ch_data['accounts_detail'].get('active_directors') %}
                    <div class="mt-4 pt-3 border-top">
                        <h6><i class="fas fa-users text-primary"></i> Active Directors/Officers ({{ ch_data['accounts_detail'].get('total_active_directors', ch_data['accounts_detail']['active_directors']|length) }})</h6>
                        
                        <div class="row">
                            {% for director in ch_data['accounts_detail']['active_directors'][:6] %}
                            <div class="col-md-6 mb-3">
                                <div class="card h-100">
                                    <div class="card-body">
                                        <h6 class="card-title mb-1">{{ director.name }}</h6>
                                        {% if director.role %}
                                        <p class="mb-1"><span class="badge bg-secondary">{{ director.role }}</span></p>
                                        {% endif %}
                                        
                                        <div class="small text-muted">
                                            {% if director.occupation %}
                                            <p class="mb-1"><i class="fas fa-briefcase"></i> {{ director.occupation }}</p>
                                            {% endif %}
                                            
                                            {% if director.appointed_on %}
                                            <p class="mb-1"><i class="fas fa-calendar"></i> Appointed: {{ director.appointed_on }}</p>
                                            {% endif %}
                                            
                                            {% if director.nationality %}
                                            <p class="mb-1"><i class="fas fa-flag"></i> {{ director.nationality }}</p>
                                            {% endif %}
                                            
                                            {% if director.date_of_birth %}
                                            <p class="mb-1"><i class="fas fa-birthday-cake"></i> Born {{ director.date_of_birth }}</p>
                                            {% endif %}
                                        </div>
                                        
                                        <!-- Add as Contact Button -->
                                        <div class="mt-2">
                                            <button type="button" 
                                                    class="btn btn-outline-primary btn-sm w-100"
                                                    onclick="addDirectorAsContact('{{ director.name|e }}', '{{ director.occupation|default('')|e }}', '{{ director.role|default('Director')|e }}', {{ customer.id }})">
                                                <i class="fas fa-user-plus"></i> Add as Contact
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        
                        {% if ch_data['accounts_detail']['active_directors']|length > 6 %}
                        <button class="btn btn-sm btn-outline-info" onclick="showAllDirectors()">
                            <i class="fas fa-eye"></i> View All {{ ch_data['accounts_detail'].get('total_active_directors', ch_data['accounts_detail']['active_directors']|length) }} Directors
                        </button>
                        {% endif %}
                    </div>
                    {% endif %}
                    {% endif %}
                    
                    <!-- Financial Data from Companies House -->
                    {% if customer.companies_house_data %}
                    {% set ch_data = customer.companies_house_data|from_json %}
                    {% if ch_data.get('accounts_detail') %}
                    <div class="mt-4 pt-3 border-top">
                        <h6><i class="fas fa-chart-line text-success"></i> Financial Data (Companies House)</h6>
                        
                        {% set accounts = ch_data['accounts_detail'] %}
                        <div class="row">
                            <div class="col-md-6">
                                <h6 class="text-primary">Current Financial Position</h6>
                                {% if accounts.get('shareholders_funds') %}
                                <p><strong>Shareholders' Funds:</strong> {{ accounts['shareholders_funds'] }}</p>
                                {% endif %}
                                {% if accounts.get('cash_at_bank') %}
                                <p><strong>Cash at Bank:</strong> {{ accounts['cash_at_bank'] }}</p>
                                {% endif %}
                                {% if accounts.get('turnover') %}
                                <p><strong>Turnover:</strong> {{ accounts['turnover'] }}</p>
                                {% endif %}
                                {% if accounts.get('employees') %}
                                <p><strong>Estimated Employees:</strong> {{ accounts['employees'] }}</p>
                                {% endif %}
                            </div>
                            <div class="col-md-6">
                                <h6 class="text-primary">Financial Trends</h6>
                                {% if accounts.get('revenue_growth') %}
                                <p><strong>Revenue Growth:</strong> 
                                    <span class="badge {% if accounts['revenue_growth'].startswith('+') %}bg-success{% elif accounts['revenue_growth'].startswith('-') %}bg-danger{% else %}bg-secondary{% endif %}">
                                        {{ accounts['revenue_growth'] }}
                                    </span>
                                </p>
                                {% endif %}
                                {% if accounts.get('profitability_trend') %}
                                <p><strong>Profitability Trend:</strong> 
                                    <span class="badge {% if accounts['profitability_trend'] == 'Growing' %}bg-success{% elif accounts['profitability_trend'] == 'Stable' %}bg-warning{% else %}bg-danger{% endif %}">
                                        {{ accounts['profitability_trend'] }}
                                    </span>
                                </p>
                                {% endif %}
                                {% if accounts.get('financial_health_score') %}
                                <p><strong>Financial Health Score:</strong> 
                                    <span class="badge {% if accounts['financial_health_score'] >= 70 %}bg-success{% elif accounts['financial_health_score'] >= 40 %}bg-warning{% else %}bg-danger{% endif %}">
                                        {{ accounts['financial_health_score'] }}/100
                                    </span>
                                </p>
                                {% endif %}
                                {% if accounts.get('years_of_data') %}
                                <p><strong>Years of Data:</strong> {{ accounts['years_of_data'] }}</p>
                                {% endif %}
                            </div>
                        </div>
                        
                        <!-- Multi-year Financial History -->
                        {% if accounts.get('detailed_financials') and accounts['detailed_financials']|length > 1 %}
                        <div class="mt-3">
                            <h6 class="text-primary">Financial History</h6>
                            <div class="table-responsive">
                                <table class="table table-sm table-striped">
                                    <thead>
                                        <tr>
                                            <th>Year</th>
                                            <th>Turnover</th>
                                            <th>Shareholders' Funds</th>
                                            <th>Cash at Bank</th>
                                            <th>Profit Before Tax</th>
                                            <th>Employees</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for year_data in accounts['detailed_financials'][:3] %}
                                        <tr>
                                            <td>
                                                {% if year_data.get('financial_year') %}
                                                    {{ year_data.get('financial_year') }}
                                                {% elif year_data.get('period_end') %}
                                                    {{ year_data.get('period_end')[:4] }}
                                                {% elif year_data.get('reporting_date') %}
                                                    {{ year_data.get('reporting_date')[:4] }}
                                                {% else %}
                                                    {{ year_data.get('filing_date', 'Unknown')[:4] }}
                                                {% endif %}
                                            </td>
                                            <td>
                                                {% if year_data.get('turnover') %}
                                                    {% if year_data['turnover'] is number %}
                                                        £{{ "{:,.0f}".format(year_data['turnover']) }}
                                                    {% else %}
                                                        {{ year_data['turnover'] }}
                                                    {% endif %}
                                                {% else %}
                                                    N/A
                                                {% endif %}
                                            </td>
                                            <td>
                                                {% if year_data.get('shareholders_funds') %}
                                                    {% if year_data['shareholders_funds'] is number %}
                                                        £{{ "{:,.0f}".format(year_data['shareholders_funds']) }}
                                                    {% else %}
                                                        {{ year_data['shareholders_funds'] }}
                                                    {% endif %}
                                                {% else %}
                                                    N/A
                                                {% endif %}
                                            </td>
                                            <td>
                                                {% if year_data.get('cash_at_bank') %}
                                                    {% if year_data['cash_at_bank'] is number %}
                                                        £{{ "{:,.0f}".format(year_data['cash_at_bank']) }}
                                                    {% else %}
                                                        {{ year_data['cash_at_bank'] }}
                                                    {% endif %}
                                                {% else %}
                                                    N/A
                                                {% endif %}
                                            </td>
                                            <td>
                                                {% if year_data.get('profit_before_tax') %}
                                                    {% if year_data['profit_before_tax'] is number %}
                                                        £{{ "{:,.0f}".format(year_data['profit_before_tax']) }}
                                                    {% else %}
                                                        {{ year_data['profit_before_tax'] }}
                                                    {% endif %}
                                                {% else %}
                                                    N/A
                                                {% endif %}
                                            </td>
                                            <td>
                                                {% if year_data.get('employees') %}
                                                    {{ year_data['employees'] }}
                                                {% else %}
                                                    <span class="text-muted">N/A</span>
                                                {% endif %}
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        {% endif %}
                        
                        <div class="mt-2">
                            <button class="btn btn-sm btn-outline-success me-2" onclick="showDetailedFinancials()">
                                <i class="fas fa-chart-bar"></i> View Detailed Financial Analysis
                            </button>
                            {% if customer.company_registration %}
                            <a href="https://find-and-update.company-information.service.gov.uk/company/{{ customer.company_registration }}" 
                               target="_blank" class="btn btn-sm btn-outline-primary">
                                <i class="fas fa-external-link-alt"></i> Companies House Filing Page
                            </a>
                            {% endif %}
                        </div>
                    </div>
                    {% endif %}
                    {% endif %}
                    
                    <!-- External Data Sources -->
                    {% if customer.linkedin_url or customer.linkedin_data or customer.companies_house_data or customer.website_data %}
                    <div class="mt-4 pt-3 border-top">
                        <h6><i class="fas fa-external-link-alt text-primary"></i> External Data Sources</h6>
                        
                        {% if customer.linkedin_url %}
                        <div class="mb-2">
                            <strong>LinkedIn:</strong> 
                            <a href="{{ customer.linkedin_url }}" target="_blank" class="text-decoration-none">
                                {{ customer.linkedin_url }} <i class="fas fa-external-link-alt small"></i>
                            </a>
                        </div>
                        {% endif %}
                        
                        {% if customer.companies_house_data %}
                        <div class="mb-2">
                            <strong>Companies House:</strong> 
                            <span class="text-success">Data available</span>
                            <button class="btn btn-sm btn-outline-info ms-2" onclick="showCompaniesHouseData()">
                                <i class="fas fa-eye"></i> View Details
                            </button>
                        </div>
                        {% endif %}
                        
                        {% if customer.website_data %}
                        <div class="mb-2">
                            <strong>Website Analysis:</strong> 
                            <span class="text-success">Data available</span>
                            <button class="btn btn-sm btn-outline-info ms-2" onclick="showWebsiteData()">
                                <i class="fas fa-eye"></i> View Details
                            </button>
                        </div>
                        {% endif %}
                    </div>
                    {% endif %}
                    
                    {% else %}
                    <div class="text-center py-3">
                        <i class="fas fa-robot fa-2x text-muted mb-2"></i>
                        <p class="text-muted">No AI analysis performed yet</p>
                        <button class="btn btn-info" onclick="analyzeCustomer()">
                            <i class="fas fa-robot"></i> Analyze with AI
                        </button>
                    </div>
                    {% endif %}
                </div>
            </div>
            
            <!-- Contacts -->
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5>Contacts ({{ contacts|length }})</h5>
                    <a href="{{ url_for('crm.new_contact', id=customer.id) }}" class="btn btn-sm btn-primary">
                        <i class="fas fa-plus"></i> Add Contact
                    </a>
                </div>
                <div class="card-body">
                    {% if contacts %}
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Role</th>
                                    <th>Email Addresses</th>
                                    <th>Phone Numbers</th>
                                    <th>Primary</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for contact in contacts %}
                                <tr>
                                    <td>
                                        <strong>{{ contact.first_name }} {{ contact.last_name }}</strong>
                                        {% if contact.job_title %}
                                        <br><small class="text-muted">{{ contact.job_title }}</small>
                                        {% endif %}
                                    </td>
                                    <td>{{ contact.role.value }}</td>
                                    <td>
                                        {% if contact.email %}
                                        <div>
                                            <strong>Primary:</strong> {{ contact.email }}
                                            {% if contact.primary_email == 'primary' %}<span class="badge bg-success small">Preferred</span>{% endif %}
                                        </div>
                                        {% endif %}
                                        {% if contact.email_secondary %}
                                        <div>
                                            <strong>Secondary:</strong> {{ contact.email_secondary }}
                                            {% if contact.primary_email == 'secondary' %}<span class="badge bg-success small">Preferred</span>{% endif %}
                                        </div>
                                        {% endif %}
                                        {% if not contact.email and not contact.email_secondary %}
                                        -
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if contact.phone %}
                                        <div>
                                            <strong>Primary:</strong> {{ contact.phone }}
                                            {% if contact.primary_phone == 'primary' %}<span class="badge bg-success small">Preferred</span>{% endif %}
                                        </div>
                                        {% endif %}
                                        {% if contact.phone_secondary %}
                                        <div>
                                            <strong>Secondary:</strong> {{ contact.phone_secondary }}
                                            {% if contact.primary_phone == 'secondary' %}<span class="badge bg-success small">Preferred</span>{% endif %}
                                        </div>
                                        {% endif %}
                                        {% if not contact.phone and not contact.phone_secondary %}
                                        -
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if contact.is_primary %}
                                        <span class="badge bg-primary">Primary Contact</span>
                                        {% else %}
                                        -
                                        {% endif %}
                                    </td>
                                    <td>
                                        <div class="btn-group" role="group">
                                            <a href="{{ url_for('crm.edit_contact', customer_id=customer.id, contact_id=contact.id) }}" class="btn btn-sm btn-outline-secondary">
                                                <i class="fas fa-edit"></i>
                                            </a>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center py-3">
                        <i class="fas fa-user-plus fa-2x text-muted mb-2"></i>
                        <p class="text-muted">No contacts added yet</p>
                        <a href="{{ url_for('crm.new_contact', id=customer.id) }}" class="btn btn-primary">
                            <i class="fas fa-plus"></i> Add First Contact
                        </a>
                    </div>
                    {% endif %}
                </div>
            </div>
            
            <!-- Quotes -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5>Related Quotes ({{ quotes|length }})</h5>
                </div>
                <div class="card-body">
                    {% if quotes %}
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Quote Number</th>
                                    <th>Project Title</th>
                                    <th>Status</th>
                                    <th>Created</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for quote in quotes %}
                                <tr>
                                    <td>{{ quote.quote_number }}</td>
                                    <td>{{ quote.project_title }}</td>
                                    <td>
                                        <span class="badge {% if quote.status == 'accepted' %}bg-success{% elif quote.status == 'sent' %}bg-primary{% elif quote.status == 'declined' %}bg-danger{% else %}bg-secondary{% endif %}">
                                            {{ quote.status.title() }}
                                        </span>
                                    </td>
                                    <td>{{ quote.created_at.strftime('%Y-%m-%d') }}</td>
                                    <td>
                                        <a href="{{ url_for('main.view_quote', quote_id=quote.id) }}" class="btn btn-sm btn-outline-primary">
                                            <i class="fas fa-eye"></i>
                                        </a>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center py-3">
                        <i class="fas fa-file-invoice fa-2x text-muted mb-2"></i>
                        <p class="text-muted">No quotes created for this customer yet</p>
                        <a href="{{ url_for('main.create_quote') }}" class="btn btn-primary">
                            <i class="fas fa-plus"></i> Create Quote
                        </a>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <div class="col-md-4">
            <!-- Interactions -->
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5>Recent Interactions</h5>
                    <!-- Interaction logging will be implemented later -->
                </div>
                <div class="card-body">
                    {% if interactions %}
                    {% for interaction in interactions[:5] %}
                    <div class="mb-3 pb-3 {% if not loop.last %}border-bottom{% endif %}">
                        <div class="d-flex justify-content-between align-items-start">
                            <strong>{{ interaction.interaction_type }}</strong>
                            <small class="text-muted">{{ interaction.created_at.strftime('%m/%d') }}</small>
                        </div>
                        <p class="mb-1 small">{{ interaction.summary }}</p>
                        {% if interaction.outcome %}
                        <small class="text-muted">Outcome: {{ interaction.outcome }}</small>
                        {% endif %}
                    </div>
                    {% endfor %}
                    {% else %}
                    <div class="text-center py-3">
                        <i class="fas fa-comments fa-2x text-muted mb-2"></i>
                        <p class="text-muted small">No interactions recorded</p>
                    </div>
                    {% endif %}
                </div>
            </div>
            
            <!-- Quick Actions -->
            <div class="card">
                <div class="card-header">
                    <h5>Quick Actions</h5>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <a href="{{ url_for('main.create_quote') }}?customer_id={{ customer.id }}" class="btn btn-primary">
                            <i class="fas fa-file-invoice"></i> Create Quote
                        </a>
                        <a href="{{ url_for('crm.new_contact', id=customer.id) }}" class="btn btn-outline-primary">
                            <i class="fas fa-user-plus"></i> Add Contact
                        </a>
                        <!-- Interaction logging will be implemented later -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function analyzeCustomer() {
    if (confirm('This will use AI to analyze the company and update business intelligence fields. Continue?')) {
        // Show loading state
        const button = event.target;
        const originalText = button.innerHTML;
        button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Analyzing...';
        button.disabled = true;
        fetch(`/crm/customers/{{ customer.id }}/ai-analysis`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => {
            console.log('Response status:', response.status);
            console.log('Response headers:', response.headers);
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            return response.json();
        })
        .then(data => {
                    console.log('Response data:', data);
                    if (data.success) {
                        // Check if AI found a company registration number
                        if (data.newly_found_company_registration) {
                            showRegistrationConfirmation(data.newly_found_company_registration);
                        } else {
                            alert('AI analysis completed successfully!');
                            location.reload();
                        }
                    } else {
                        alert('AI analysis failed: ' + (data.error || data.message || 'Unknown error'));
                        // Restore button state
                        button.innerHTML = originalText;
                        button.disabled = false;
                    }
                })
        .catch(error => {
            console.error('Error:', error);
            alert('Error during AI analysis: ' + error.message);
            // Restore button state
            button.innerHTML = originalText;
            button.disabled = false;
        });
    }
}

function showAllDirectors() {
    {% if customer.companies_house_data %}
    const data = JSON.parse('{{ customer.companies_house_data|safe }}');
    
    if (data.accounts_detail && data.accounts_detail.active_directors) {
        const directors = data.accounts_detail.active_directors;
        
        let content = '<div class="directors-list">';
        content += `<h6><i class="fas fa-users"></i> All Active Directors (${directors.length})</h6>`;
        
        directors.forEach((director, index) => {
            content += `<div class="card mb-2">`;
            content += `<div class="card-body">`;
            content += `<h6 class="card-title">${index + 1}. ${director.name || 'Unknown'}</h6>`;
            
            if (director.role) {
                content += `<p class="mb-1"><span class="badge bg-secondary">${director.role}</span></p>`;
            }
            
            content += `<div class="row">`;
            content += `<div class="col-md-6">`;
            
            if (director.occupation) {
                content += `<p class="mb-1 small text-muted"><i class="fas fa-briefcase"></i> ${director.occupation}</p>`;
            }
            if (director.appointed_on) {
                content += `<p class="mb-1 small text-muted"><i class="fas fa-calendar"></i> Appointed: ${director.appointed_on}</p>`;
            }
            if (director.nationality) {
                content += `<p class="mb-1 small text-muted"><i class="fas fa-flag"></i> ${director.nationality}</p>`;
            }
            
            content += `</div><div class="col-md-6">`;
            
            if (director.country_of_residence) {
                content += `<p class="mb-1 small text-muted"><i class="fas fa-home"></i> Residence: ${director.country_of_residence}</p>`;
            }
            if (director.date_of_birth) {
                content += `<p class="mb-1 small text-muted"><i class="fas fa-birthday-cake"></i> Born ${director.date_of_birth}</p>`;
            }
            if (director.address) {
                content += `<p class="mb-1 small text-muted"><i class="fas fa-map-marker-alt"></i> ${director.address}</p>`;
            }
            
            content += `</div></div>`;
            content += `</div></div>`;
        });
        
        content += '</div>';
        
        showModal('Active Directors & Officers', content);
    }
    {% endif %}
}

function showCompaniesHouseData() {
    {% if customer.companies_house_data %}
    const data = JSON.parse('{{ customer.companies_house_data|safe }}');
    
    let content = '<div class="companies-house-data">';
    content += '<h6><i class="fas fa-building"></i> Companies House Information</h6>';
    
    if (data.company_number) {
        content += `<p><strong>Company Number:</strong> ${data.company_number}</p>`;
    }
    if (data.company_status) {
        content += `<p><strong>Status:</strong> <span class="badge bg-info">${data.company_status}</span></p>`;
    }
    if (data.company_type) {
        content += `<p><strong>Type:</strong> ${data.company_type}</p>`;
    }
    if (data.date_of_creation) {
        content += `<p><strong>Founded:</strong> ${data.date_of_creation}</p>`;
    }
    if (data.registered_office_address) {
        content += `<p><strong>Registered Address:</strong><br>`;
        let fullAddress = '';
        if (typeof data.registered_office_address === 'object') {
            fullAddress = `${data.registered_office_address.address_line_1 || ''} ${data.registered_office_address.locality || ''} ${data.registered_office_address.postal_code || ''}`.trim();
            content += `${data.registered_office_address.address_line_1 || ''}<br>`;
            content += `${data.registered_office_address.locality || ''}<br>`;
            content += `${data.registered_office_address.postal_code || ''}`;
        } else {
            fullAddress = data.registered_office_address;
            content += data.registered_office_address;
        }
        content += '</p>';
        if (fullAddress) {
            const encodedAddress = encodeURIComponent(fullAddress);
            content += `<a href="https://www.google.com/maps/search/?api=1&query=${encodedAddress}" target="_blank" class="btn btn-outline-primary btn-sm">
                <i class="fas fa-map-marker-alt"></i> Open in Google Maps
            </a>`;
        }
    }
    if (data.sic_codes && data.sic_codes.length > 0) {
        content += '<p><strong>SIC Codes:</strong><br>';
        data.sic_codes.forEach(sic => {
            content += `${sic.sic_code}: ${sic.description}<br>`;
        });
        content += '</p>';
    }
    
    content += '</div>';
    
    showModal('Companies House Data', content);
    {% endif %}
}

function showDetailedFinancials() {
    {% if customer.companies_house_data %}
    const data = JSON.parse('{{ customer.companies_house_data|safe }}');
    const accounts = data.accounts_detail;
    
    if (!accounts) {
        showModal('Detailed Financial Analysis', '<p class="text-muted">No detailed financial data available.</p>');
        return;
    }
    
    let content = '<div class="detailed-financials">';
    content += '<h6><i class="fas fa-chart-line"></i> Detailed Financial Analysis</h6>';
    
    // Current Financial Position
    content += '<div class="mb-4">';
    content += '<h6 class="text-primary">Current Financial Position</h6>';
    
    if (accounts.shareholders_funds) {
        content += `<p><strong>Shareholders' Funds:</strong> ${accounts.shareholders_funds}</p>`;
    }
    if (accounts.cash_at_bank) {
        content += `<p><strong>Cash at Bank:</strong> ${accounts.cash_at_bank}</p>`;
    }
    if (accounts.turnover) {
        content += `<p><strong>Turnover:</strong> ${accounts.turnover}</p>`;
    }
    if (accounts.employees) {
        content += `<p><strong>Estimated Employees:</strong> ${accounts.employees}</p>`;
    }
    if (accounts.company_size) {
        content += `<p><strong>Company Size:</strong> <span class="badge bg-info">${accounts.company_size}</span></p>`;
    }
    if (accounts.filing_date) {
        content += `<p><strong>Last Accounts Filed:</strong> ${accounts.filing_date}</p>`;
    }
    
    content += '</div>';
    
    // Financial Trends
    if (accounts.revenue_growth || accounts.profitability_trend || accounts.financial_health_score) {
        content += '<div class="mb-4">';
        content += '<h6 class="text-primary">Financial Trends</h6>';
        
        if (accounts.revenue_growth) {
            const growthClass = accounts.revenue_growth.startsWith('+') ? 'text-success' : 
                              accounts.revenue_growth.startsWith('-') ? 'text-danger' : 'text-muted';
            content += `<p><strong>Revenue Growth:</strong> <span class="${growthClass}">${accounts.revenue_growth}</span></p>`;
        }
        if (accounts.profitability_trend) {
            const trendClass = accounts.profitability_trend === 'Growing' ? 'text-success' : 
                              accounts.profitability_trend === 'Declining' ? 'text-danger' : 'text-warning';
            content += `<p><strong>Profitability Trend:</strong> <span class="${trendClass}">${accounts.profitability_trend}</span></p>`;
        }
        if (accounts.financial_health_score) {
            const healthClass = accounts.financial_health_score >= 70 ? 'text-success' : 
                               accounts.financial_health_score >= 40 ? 'text-warning' : 'text-danger';
            content += `<p><strong>Financial Health Score:</strong> <span class="${healthClass}">${accounts.financial_health_score}/100</span></p>`;
        }
        if (accounts.years_of_data) {
            content += `<p><strong>Years of Data Available:</strong> ${accounts.years_of_data}</p>`;
        }
        
        content += '</div>';
    }
    
    // Multi-year Financial History
    if (accounts.detailed_financials && accounts.detailed_financials.length > 0) {
        content += '<div class="mb-4">';
        content += '<h6 class="text-primary">Financial History</h6>';
        
        content += '<div class="table-responsive">';
        content += '<table class="table table-sm table-striped">';
        content += '<thead><tr><th>Year</th><th>Turnover</th><th>Shareholders\' Funds</th><th>Cash at Bank</th><th>Profit Before Tax</th><th>Employees</th></tr></thead>';
        content += '<tbody>';
        
        accounts.detailed_financials.forEach(yearData => {
            content += '<tr>';
            // Use financial year if available, otherwise filing date
            let yearDisplay = 'Unknown';
            if (yearData.financial_year) {
                yearDisplay = yearData.financial_year;
            } else if (yearData.period_end) {
                yearDisplay = yearData.period_end.substring(0, 4);
            } else if (yearData.reporting_date) {
                yearDisplay = yearData.reporting_date.substring(0, 4);
            } else if (yearData.filing_date) {
                yearDisplay = yearData.filing_date.substring(0, 4);
            }
            content += `<td>${yearDisplay}</td>`;
            
            // Turnover
            if (yearData.turnover) {
                if (typeof yearData.turnover === 'number') {
                    content += `<td>£${yearData.turnover.toLocaleString()}</td>`;
                } else {
                    content += `<td>${yearData.turnover}</td>`;
                }
            } else {
                content += '<td class="text-muted">N/A</td>';
            }
            
            // Shareholders' Funds
            if (yearData.shareholders_funds) {
                if (typeof yearData.shareholders_funds === 'number') {
                    content += `<td>£${yearData.shareholders_funds.toLocaleString()}</td>`;
                } else {
                    content += `<td>${yearData.shareholders_funds}</td>`;
                }
            } else {
                content += '<td class="text-muted">N/A</td>';
            }
            
            // Cash at Bank
            if (yearData.cash_at_bank) {
                if (typeof yearData.cash_at_bank === 'number') {
                    content += `<td>£${yearData.cash_at_bank.toLocaleString()}</td>`;
                } else {
                    content += `<td>${yearData.cash_at_bank}</td>`;
                }
            } else {
                content += '<td class="text-muted">N/A</td>';
            }
            
            // Profit Before Tax
            if (yearData.profit_before_tax) {
                if (typeof yearData.profit_before_tax === 'number') {
                    const profitClass = yearData.profit_before_tax >= 0 ? 'text-success' : 'text-danger';
                    content += `<td class="${profitClass}">£${yearData.profit_before_tax.toLocaleString()}</td>`;
                } else {
                    content += `<td>${yearData.profit_before_tax}</td>`;
                }
            } else {
                content += '<td class="text-muted">N/A</td>';
            }
            
            // Employees
            if (yearData.employees) {
                content += `<td>${yearData.employees}</td>`;
            } else {
                content += '<td class="text-muted">N/A</td>';
            }
            
            content += '</tr>';
        });
        
        content += '</tbody></table></div></div>';
    }
    
    // Analysis Summary
    content += '<div class="mb-4">';
    content += '<h6 class="text-primary">Analysis Summary</h6>';
    
    if (accounts.financial_health_score >= 70) {
        content += '<p class="text-success"><i class="fas fa-check-circle"></i> <strong>Strong Financial Health:</strong> This company shows good financial stability and growth potential.</p>';
    } else if (accounts.financial_health_score >= 40) {
        content += '<p class="text-warning"><i class="fas fa-exclamation-triangle"></i> <strong>Moderate Financial Health:</strong> This company has average financial stability.</p>';
    } else {
        content += '<p class="text-danger"><i class="fas fa-exclamation-circle"></i> <strong>Weak Financial Health:</strong> This company may have financial challenges.</p>';
    }
    
    if (accounts.profitability_trend === 'Growing') {
        content += '<p class="text-success"><i class="fas fa-arrow-up"></i> <strong>Growing Profitability:</strong> The company is showing positive financial trends.</p>';
    } else if (accounts.profitability_trend === 'Declining') {
        content += '<p class="text-danger"><i class="fas fa-arrow-down"></i> <strong>Declining Profitability:</strong> The company may be facing financial challenges.</p>';
    }
    
    content += '</div>';
    content += '</div>';
    
    showModal('Detailed Financial Analysis', content);
    {% else %}
    showModal('Detailed Financial Analysis', '<p class="text-muted">No Companies House data available for detailed analysis.</p>');
    {% endif %}
}

function showWebsiteData() {
    {% if customer.website_data %}
    const data = JSON.parse('{{ customer.website_data|safe }}');
    
    let content = '<div class="website-data">';
    content += '<h6><i class="fas fa-globe"></i> Website Analysis</h6>';
    
    if (data.website_title) {
        content += `<p><strong>Website Title:</strong> ${data.website_title}</p>`;
    }
    if (data.website_description) {
        content += `<p><strong>Description:</strong> ${data.website_description}</p>`;
    }
    if (data.contact_info && data.contact_info.length > 0) {
        content += '<p><strong>Contact Information Found:</strong><br>';
        data.contact_info.forEach(contact => {
            content += `${contact}<br>`;
        });
        content += '</p>';
    }
    if (data.social_media && data.social_media.length > 0) {
        content += '<p><strong>Social Media Links:</strong><br>';
        data.social_media.forEach(link => {
            content += `<a href="${link}" target="_blank">${link}</a><br>`;
        });
        content += '</p>';
    }
    if (data.key_phrases && data.key_phrases.length > 0) {
        content += '<p><strong>Key Phrases:</strong><br>';
        content += data.key_phrases.slice(0, 15).map(phrase => phrase[0]).join(', ');
        content += '</p>';
    }
    
    content += '</div>';
    
    showModal('Website Analysis', content);
    {% endif %}
}

function showModal(title, content) {
    const modal = document.createElement('div');
    modal.className = 'modal fade';
    modal.innerHTML = `
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">${title}</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    ${content}
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    const bsModal = new bootstrap.Modal(modal);
    bsModal.show();
    
    // Clean up modal when hidden
    modal.addEventListener('hidden.bs.modal', () => {
        document.body.removeChild(modal);
    });
}

function showStatusChangeModal() {
    const modal = document.createElement('div');
    modal.className = 'modal fade';
    modal.innerHTML = `
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Change Customer Status</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="statusChangeForm">
                        <div class="mb-3">
                            <label for="new_status" class="form-label">New Status</label>
                            <select class="form-select" id="new_status" name="status" required>
                                <option value="lead" {% if customer.status.value == 'lead' %}selected{% endif %}>Lead</option>
                                <option value="prospect" {% if customer.status.value == 'prospect' %}selected{% endif %}>Prospect</option>
                                <option value="active" {% if customer.status.value == 'active' %}selected{% endif %}>Active Customer</option>
                                <option value="inactive" {% if customer.status.value == 'inactive' %}selected{% endif %}>Inactive</option>
                                <option value="former" {% if customer.status.value == 'former' %}selected{% endif %}>Former Customer</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="status_notes" class="form-label">Notes (Optional)</label>
                            <textarea class="form-control" id="status_notes" name="notes" rows="3" placeholder="Add notes about this status change..."></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="changeCustomerStatus()">Change Status</button>
                </div>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    const bsModal = new bootstrap.Modal(modal);
    bsModal.show();
    
    // Clean up modal when hidden
    modal.addEventListener('hidden.bs.modal', () => {
        document.body.removeChild(modal);
    });
}

function changeCustomerStatus() {
    const newStatus = document.getElementById('new_status').value;
    const notes = document.getElementById('status_notes').value;
    
    const data = {
        status: newStatus,
        notes: notes
    };
    
    fetch(`/crm/customers/{{ customer.id }}/change-status`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Update the status badge
            const statusBadge = document.getElementById('status-badge');
            statusBadge.textContent = newStatus.charAt(0).toUpperCase() + newStatus.slice(1);
            
            // Update badge color
            statusBadge.className = 'badge';
            if (newStatus === 'active') {
                statusBadge.classList.add('bg-success');
            } else if (newStatus === 'lead') {
                statusBadge.classList.add('bg-primary');
            } else if (newStatus === 'prospect') {
                statusBadge.classList.add('bg-info');
            } else if (newStatus === 'inactive') {
                statusBadge.classList.add('bg-warning');
            } else {
                statusBadge.classList.add('bg-secondary');
            }
            
            // Close modal
            const modal = document.querySelector('.modal');
            const bsModal = bootstrap.Modal.getInstance(modal);
            bsModal.hide();
            
            alert('Status changed successfully!');
        } else {
            alert('Error changing status: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error changing status');
    });
}

function showRegistrationConfirmation(registrationNumber) {
    const modal = document.createElement('div');
    modal.className = 'modal fade';
    modal.innerHTML = `
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">AI Found Company Registration</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-info">
                        <i class="fas fa-robot"></i> AI Analysis found a company registration number:
                    </div>
                    <div class="text-center mb-3">
                        <h4><span class="badge bg-primary fs-5">${registrationNumber}</span></h4>
                    </div>
                    <p class="text-muted">Would you like to add this company registration number to the customer record?</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" onclick="dismissRegistrationModal()">No, Skip</button>
                    <button type="button" class="btn btn-success" onclick="confirmRegistration('${registrationNumber}')">
                        <i class="fas fa-check"></i> Yes, Add Registration
                    </button>
                </div>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    const bsModal = new bootstrap.Modal(modal);
    bsModal.show();
    
    // Clean up modal when hidden
    modal.addEventListener('hidden.bs.modal', () => {
        document.body.removeChild(modal);
    });
}

function confirmRegistration(registrationNumber) {
    fetch(`/crm/customers/{{ customer.id }}/update-registration`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            company_registration: registrationNumber
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Company registration number added successfully!');
            location.reload();
        } else {
            alert('Error adding registration number: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error adding registration number');
    });
}

function dismissRegistrationModal() {
    // Just reload the page to show the completed AI analysis
    location.reload();
}

function toggleRegistrationConfirmation(checkbox) {
    const confirmed = checkbox.checked;
    
    fetch(`/crm/customers/{{ customer.id }}/toggle-registration-confirmation`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            confirmed: confirmed
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Update the badge color based on confirmation status
            const badge = document.querySelector('.badge.bg-info');
            if (badge) {
                if (confirmed) {
                    badge.className = 'badge bg-success';
                } else {
                    badge.className = 'badge bg-warning';
                }
            }
        } else {
            alert('Error updating confirmation status: ' + data.error);
            // Revert checkbox state
            checkbox.checked = !confirmed;
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error updating confirmation status');
        // Revert checkbox state
        checkbox.checked = !confirmed;
    });
}

// Function to create competitors campaign
function addCompetitorsToCampaign() {
    // Create modal for confirmation
    const modal = `
        <div class="modal fade" id="competitorsModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Create Competitors Campaign</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <p>This will create a new lead generation campaign specifically for competitor companies and automatically run it to collect detailed data.</p>
                        <div class="alert alert-info">
                            <strong>Competitors to analyze:</strong>
                            <div id="preview-competitors"></div>
                        </div>
                        <div class="alert alert-warning">
                            <i class="fas fa-info-circle"></i> The campaign will be named "<span id="campaign-name-preview"></span>" and will run automatically in the background.
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-primary" onclick="createCompetitorsCampaign()">Create Campaign</button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Remove existing modal if any
    const existingModal = document.getElementById('competitorsModal');
    if (existingModal) {
        existingModal.remove();
    }
    
    // Add modal to page
    document.body.insertAdjacentHTML('beforeend', modal);
    
    // Show modal
    const modalInstance = new bootstrap.Modal(document.getElementById('competitorsModal'));
    modalInstance.show();
    
    // Show preview of competitors
    const competitorsText = document.getElementById('competitors-text').textContent;
    document.getElementById('preview-competitors').textContent = competitorsText.substring(0, 200) + '...';
    
    // Generate campaign name preview
    const sourceCompany = document.querySelector('h2').textContent.trim();
    console.log('Source company found:', sourceCompany);
    
    const now = new Date();
    const dateTime = now.toLocaleString('en-GB', {
        day: '2-digit',
        month: '2-digit', 
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
    }).replace(/,/g, '').replace(/\//g, '-').replace(/:/g, '-');
    
    const campaignName = `Competitors of ${sourceCompany} - ${dateTime}`;
    console.log('Campaign name generated:', campaignName);
    document.getElementById('campaign-name-preview').textContent = campaignName;
}

function createCompetitorsCampaign() {
    const competitorsText = document.getElementById('competitors-text').textContent;
    const sourceCompany = document.querySelector('h2').textContent.trim(); // Get company name from page title
    
    // Show loading state
    const button = event.target;
    const originalText = button.textContent;
    button.textContent = 'Creating...';
    button.disabled = true;
    
    // Send request
    fetch('/lead-generation/create-competitors-campaign', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            competitors_text: competitorsText,
            source_company: sourceCompany
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(`Success! Created competitor campaign "${data.campaign_name}" with ${data.competitors_added.length} companies. The campaign is now running in the background to collect detailed data.`);
            // Close modal
            bootstrap.Modal.getInstance(document.getElementById('competitorsModal')).hide();
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error creating competitors campaign');
    })
    .finally(() => {
        button.textContent = originalText;
        button.disabled = false;
    });
}

// Function to add director as contact
function addDirectorAsContact(fullName, occupation, role, customerId) {
    // Parse the full name to get first and last name
    // Handle both "First Last" and "Last, First" formats
    let firstName = '';
    let lastName = '';
    
    if (fullName.includes(',')) {
        // Format: "Last, First Middle" or "Last, First"
        const parts = fullName.trim().split(',');
        lastName = parts[0].trim();
        const firstPart = parts[1] ? parts[1].trim() : '';
        firstName = firstPart;
    } else {
        // Format: "First Last" or "First Middle Last"
        const nameParts = fullName.trim().split(' ');
        firstName = nameParts[0] || '';
        lastName = nameParts.slice(1).join(' ') || '';
    }
    
    // Determine the job title - prefer occupation, fallback to role
    const jobTitle = occupation || role || 'Director';
    
    // Show confirmation modal
    const modal = `
        <div class="modal fade" id="addContactModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Add Contact</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <p>Add <strong>${fullName}</strong> as a contact for this customer?</p>
                        <div class="mb-3">
                            <label for="contact_first_name" class="form-label">First Name</label>
                            <input type="text" class="form-control" id="contact_first_name" value="${firstName}">
                        </div>
                        <div class="mb-3">
                            <label for="contact_last_name" class="form-label">Last Name</label>
                            <input type="text" class="form-control" id="contact_last_name" value="${lastName}">
                        </div>
                        <div class="mb-3">
                            <label for="contact_job_title" class="form-label">Job Title</label>
                            <input type="text" class="form-control" id="contact_job_title" value="${jobTitle}">
                        </div>
                        <div class="mb-3">
                            <label for="contact_role" class="form-label">Role</label>
                            <select class="form-select" id="contact_role">
                                <option value="decision_maker">Decision Maker</option>
                                <option value="technical">Technical</option>
                                <option value="finance">Finance</option>
                                <option value="facilities">Facilities</option>
                                <option value="it_manager">IT Manager</option>
                                <option value="general">General</option>
                            </select>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-primary" onclick="createContactFromDirector(${customerId})">Add Contact</button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Remove existing modal if any
    const existingModal = document.getElementById('addContactModal');
    if (existingModal) {
        existingModal.remove();
    }
    
    // Add modal to page
    document.body.insertAdjacentHTML('beforeend', modal);
    
    // Show modal
    const modalElement = new bootstrap.Modal(document.getElementById('addContactModal'));
    modalElement.show();
}

// Function to create contact from director data
function createContactFromDirector(customerId) {
    const firstName = document.getElementById('contact_first_name').value.trim();
    const lastName = document.getElementById('contact_last_name').value.trim();
    const jobTitle = document.getElementById('contact_job_title').value.trim();
    const role = document.getElementById('contact_role').value;
    
    if (!firstName || !lastName) {
        alert('Please provide both first and last name.');
        return;
    }
    
    // Show loading state
    const button = event.target;
    const originalText = button.innerHTML;
    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Adding...';
    button.disabled = true;
    
    // Create contact data
    const contactData = {
        first_name: firstName,
        last_name: lastName,
        job_title: jobTitle,
        role: role
    };
    
    // Send request to create contact
    fetch(`/crm/customers/${customerId}/contacts`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(contactData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('addContactModal'));
            modal.hide();
            
            // Show success message
            alert('Contact added successfully!');
            
            // Reload page to show the new contact
            location.reload();
        } else {
            alert('Error adding contact: ' + (data.error || 'Unknown error'));
            button.innerHTML = originalText;
            button.disabled = false;
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error adding contact. Please try again.');
        button.innerHTML = originalText;
        button.disabled = false;
    });
}

// Address Management Functions

// Function to show add address modal
function showAddAddressModal() {
    const modal = `
        <div class="modal fade" id="addAddressModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Add Manual Address</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="address_name" class="form-label">Address Name</label>
                            <input type="text" class="form-control" id="address_name" placeholder="e.g., London Office, Manchester Branch">
                        </div>
                        <div class="mb-3">
                            <label for="address_address" class="form-label">Full Address</label>
                            <textarea class="form-control" id="address_address" rows="3" placeholder="Enter full address including postcode"></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="address_phone" class="form-label">Phone Number (Optional)</label>
                            <input type="text" class="form-control" id="address_phone" placeholder="e.g., +44 20 1234 5678">
                        </div>
                        <div class="mb-3">
                            <label for="address_notes" class="form-label">Notes (Optional)</label>
                            <textarea class="form-control" id="address_notes" rows="2" placeholder="Any additional information about this address"></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-primary" onclick="addManualAddress()">Add Address</button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Remove existing modal if any
    const existingModal = document.getElementById('addAddressModal');
    if (existingModal) {
        existingModal.remove();
    }
    
    // Add modal to page
    document.body.insertAdjacentHTML('beforeend', modal);
    
    // Show modal
    const modalElement = new bootstrap.Modal(document.getElementById('addAddressModal'));
    modalElement.show();
}

// Function to add manual address
function addManualAddress() {
    const name = document.getElementById('address_name').value.trim();
    const address = document.getElementById('address_address').value.trim();
    const phone = document.getElementById('address_phone').value.trim();
    const notes = document.getElementById('address_notes').value.trim();
    
    if (!name || !address) {
        alert('Please provide both address name and full address.');
        return;
    }
    
    // Show loading state
    const button = event.target;
    const originalText = button.innerHTML;
    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Adding...';
    button.disabled = true;
    
    // Create address data
    const addressData = {
        name: name,
        address: address,
        phone: phone,
        notes: notes
    };
    
    // Get customer ID from the page
    const customerId = {{ customer.id }};
    
    // Send request to add address
    fetch(`/crm/customers/${customerId}/addresses/manual`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(addressData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('addAddressModal'));
            modal.hide();
            
            // Show success message
            alert('Address added successfully!');
            
            // Reload page to show the new address
            location.reload();
        } else {
            alert('Error adding address: ' + (data.error || 'Unknown error'));
            button.innerHTML = originalText;
            button.disabled = false;
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error adding address. Please try again.');
        button.innerHTML = originalText;
        button.disabled = false;
    });
}

// Function to remove manual address
function removeManualAddress(addressName, customerId) {
    if (!confirm(`Are you sure you want to remove "${addressName}"?`)) {
        return;
    }
    
    fetch(`/crm/customers/${customerId}/addresses/manual`, {
        method: 'DELETE',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ name: addressName })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Address removed successfully!');
            location.reload();
        } else {
            alert('Error removing address: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error removing address. Please try again.');
    });
}

// Function to toggle address exclusion
function toggleAddressExclusion(locationId, customerId, exclude) {
    const action = exclude ? 'exclude' : 'include';
    
    fetch(`/crm/customers/${customerId}/addresses/${action}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ location_id: locationId })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            if (exclude) {
                // Hide the address element
                const addressElement = document.getElementById(`address_${locationId}`);
                if (addressElement) {
                    addressElement.style.display = 'none';
                }
            }
            // Reload page to update the display
            location.reload();
        } else {
            alert('Error updating address: ' + (data.error || 'Unknown error'));
            // Reset checkbox
            const checkbox = document.getElementById(`exclude_${locationId}`);
            if (checkbox) {
                checkbox.checked = !exclude;
            }
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error updating address. Please try again.');
        // Reset checkbox
        const checkbox = document.getElementById(`exclude_${locationId}`);
        if (checkbox) {
            checkbox.checked = !exclude;
        }
    });
}

// Function to update selected count and button state
function updateAddressSelection() {
    const checkboxes = document.querySelectorAll('.address-checkbox:checked');
    const count = checkboxes.length;
    
    document.getElementById('selectedCount').textContent = count;
    document.getElementById('addToCampaignBtn').disabled = count === 0;
}

// Function to add selected addresses to campaign
function addSelectedAddressesToCampaign() {
    // Get selected addresses only
    const selectedAddresses = [];
    const checkboxes = document.querySelectorAll('.address-checkbox:checked');
    
    checkboxes.forEach(checkbox => {
        selectedAddresses.push({
            name: checkbox.dataset.addressName,
            address: checkbox.dataset.addressAddress,
            phone: checkbox.dataset.addressPhone,
            type: checkbox.dataset.addressType
        });
    });
    
    if (selectedAddresses.length === 0) {
        alert('Please select at least one address to add to campaign.');
        return;
    }
    
    // Create modal for confirmation
    const modal = `
        <div class="modal fade" id="addressesModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Create Address-Based Campaign</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <p>This will create a new lead generation campaign targeting businesses in the same locations as this customer's verified addresses.</p>
                        <div class="alert alert-info">
                            <strong>Target locations:</strong>
                            <div id="preview-addresses"></div>
                        </div>
                        <div class="alert alert-warning">
                            <i class="fas fa-info-circle"></i> The campaign will be named "<span id="address-campaign-name-preview"></span>" and will run automatically in the background.
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-primary" onclick="createAddressesCampaign()">Create Campaign</button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Remove existing modal if any
    const existingModal = document.getElementById('addressesModal');
    if (existingModal) {
        existingModal.remove();
    }
    
    // Add modal to page
    document.body.insertAdjacentHTML('beforeend', modal);
    
    // Generate campaign name preview
    const sourceCompany = document.querySelector('h2').textContent.trim();
    const now = new Date();
    const dateTime = now.toLocaleString('en-GB', {
        day: '2-digit',
        month: '2-digit', 
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
    }).replace(/,/g, '').replace(/\//g, '-').replace(/:/g, '-');
    const campaignName = `Locations of ${sourceCompany} - ${dateTime}`;
    document.getElementById('address-campaign-name-preview').textContent = campaignName;
    
    // Show selected addresses preview
    const addressesPreview = selectedAddresses.map(addr => 
        `<div class="small mb-1"><strong>${addr.name}:</strong> ${addr.address}</div>`
    ).join('');
    document.getElementById('preview-addresses').innerHTML = addressesPreview;
    
    // Show modal
    const modalElement = new bootstrap.Modal(document.getElementById('addressesModal'));
    modalElement.show();
}

// Function to create addresses campaign
function createAddressesCampaign() {
    // Get selected addresses only
    const selectedAddresses = [];
    const checkboxes = document.querySelectorAll('.address-checkbox:checked');
    
    checkboxes.forEach(checkbox => {
        selectedAddresses.push({
            name: checkbox.dataset.addressName,
            address: checkbox.dataset.addressAddress,
            phone: checkbox.dataset.addressPhone,
            type: checkbox.dataset.addressType
        });
    });
    
    // Show loading state
    const button = event.target;
    const originalText = button.innerHTML;
    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Creating...';
    button.disabled = true;
    
    // Create campaign data
    const campaignData = {
        addresses: selectedAddresses,
        source_company: document.querySelector('h2').textContent.trim()
    };
    
    // Send request to create campaign
    fetch('/lead-generation/create-addresses-campaign', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(campaignData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('addressesModal'));
            modal.hide();
            
            // Show success message
            alert(`Campaign created successfully! ${data.campaign_name} is now running in the background.`);
            
            // Optionally redirect to campaign detail
            if (data.campaign_id) {
                if (confirm('Would you like to view the campaign details?')) {
                    window.location.href = `/lead-generation/campaigns/${data.campaign_id}`;
                }
            }
        } else {
            alert('Error creating campaign: ' + (data.error || 'Unknown error'));
            button.innerHTML = originalText;
            button.disabled = false;
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error creating campaign. Please try again.');
        button.innerHTML = originalText;
        button.disabled = false;
    });
}

// Add event listeners for address checkboxes
document.addEventListener('DOMContentLoaded', function() {
    // Add change event listeners to all address checkboxes
    document.addEventListener('change', function(e) {
        if (e.target.classList.contains('address-checkbox')) {
            updateAddressSelection();
        }
    });
    
    // Initialize the selection count
    updateAddressSelection();
});
</script>
{% endblock %}
